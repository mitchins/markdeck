name: Build and Release Binaries

on:
  push:
    tags:
      - 'v*'
  schedule:
    - cron: '0 3 * * *'  # Nightly at 3 AM UTC
  workflow_dispatch:

jobs:
  build-binaries:
    name: Build ${{ matrix.os }} binaries
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
    
    strategy:
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
            targets: node20-linux-x64
            artifacts: markdeck-linux-x64
          - os: macos
            runner: macos-latest
            targets: node20-macos-x64,node20-macos-arm64
            artifacts: markdeck-macos-x64 markdeck-macos-arm64
          - os: windows
            runner: windows-latest
            targets: node20-win-x64
            artifacts: markdeck-win-x64.exe
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build TUI and bundle
        run: |
          npm run build:tui
          cd packages/tui && npm run bundle
      
      - name: Build binaries with pkg
        run: |
          cd packages/tui
          npx pkg dist/bundle/cli.cjs --compress Brotli -t ${{ matrix.targets }} -o dist/bin/markdeck
      
      - name: Rename binaries (Linux/macOS)
        if: matrix.os != 'windows'
        run: |
          cd packages/tui/dist/bin
          # pkg creates binaries named 'markdeck-<platform>' when multiple targets
          # or 'markdeck' when single target - handle both cases
          if [ -f "markdeck" ] && [ ! -f "markdeck-linux-x64" ] && [ ! -f "markdeck-macos-x64" ] && [ ! -f "markdeck-macos-arm64" ]; then
            # Single binary case - rename based on first target
            platform=$(echo "${{ matrix.targets }}" | cut -d',' -f1 | cut -d'-' -f2-)
            mv markdeck "markdeck-$platform"
            echo "Renamed single binary to markdeck-$platform"
          fi
          ls -lh
      
      - name: Rename binaries (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          cd packages/tui/dist/bin
          if (Test-Path markdeck.exe) {
            Rename-Item markdeck.exe markdeck-win-x64.exe
          }
          Get-ChildItem
      
      - name: Generate checksums (Linux/macOS)
        if: matrix.os != 'windows'
        run: |
          cd packages/tui/dist/bin
          for artifact in ${{ matrix.artifacts }}; do
            if [ -f "$artifact" ]; then
              sha256sum "$artifact" > "$artifact.sha256"
            fi
          done
      
      - name: Generate checksums (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          cd packages/tui/dist/bin
          $artifacts = "${{ matrix.artifacts }}".Split(" ")
          foreach ($artifact in $artifacts) {
            if (Test-Path $artifact) {
              $hash = (Get-FileHash -Algorithm SHA256 $artifact).Hash.ToLower()
              "$hash  $artifact" | Out-File -FilePath "$artifact.sha256" -Encoding ASCII
            }
          }
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.os }}
          path: |
            packages/tui/dist/bin/markdeck-*
            packages/tui/dist/bin/*.sha256
          if-no-files-found: error
  
  publish-release:
    name: Publish GitHub Release
    needs: build-binaries
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries
          pattern: binaries-*
          merge-multiple: true
      
      - name: List downloaded binaries
        run: |
          ls -lh binaries/
          echo "Generating release notes..."
      
      - name: Extract changelog from STATUS.md
        id: changelog
        run: |
          # Extract the first section from STATUS.md as release notes
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          head -50 STATUS.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: binaries/*
          body: |
            ## MarkDeck TUI ${{ github.ref_name }}
            
            Native binaries for Linux, macOS, and Windows.
            
            ### Downloads
            
            - **Linux (x64)**: `markdeck-linux-x64`
            - **macOS (x64)**: `markdeck-macos-x64`
            - **macOS (ARM64)**: `markdeck-macos-arm64`
            - **Windows (x64)**: `markdeck-win-x64.exe`
            
            ### Installation
            
            1. Download the appropriate binary for your platform
            2. Make it executable (Linux/macOS): `chmod +x markdeck-*`
            3. Run it: `./markdeck-<platform> [path/to/STATUS.md]`
            
            ### Checksums
            
            SHA256 checksums are provided for verification (`.sha256` files).
            
            ---
            
            ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  publish-nightly:
    name: Publish Nightly Artifacts
    needs: build-binaries
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries
          pattern: binaries-*
          merge-multiple: true
      
      - name: List nightly binaries
        run: |
          echo "Nightly build artifacts:"
          ls -lh binaries/
          echo "These are available as workflow artifacts for testing."
